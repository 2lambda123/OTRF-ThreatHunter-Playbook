
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Data Protection API &#8212; Threat Hunter Playbook</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=62ba249389abaaa9ffc34bf36a076bdc1d65ee18" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=f31d14ad54b65d19161ba51d4ffff3a77ae00456"></script>
    <script src="../../_static/tabs.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <link rel="canonical" href="https://threathunterplaybook.com/library/windows/data_protection_api.html" />
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Logon Session" href="logon_session.html" />
    <link rel="prev" title="Active Directory Federation Services (ADFS) Distributed Key Manager (DKM) Keys" href="adfs_dkm_keys.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Threat Hunter Playbook</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Knowledge Library
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="intro.html">
   Windows
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="active_directory_replication.html">
     Active Directory Replication
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="adfs_dkm_keys.html">
     Active Directory Federation Services (ADFS) Distributed Key Manager (DKM) Keys
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     Data Protection API
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="logon_session.html">
     Logon Session
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="lsa_policy_objects.html">
     LSA Policy Objects
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="mimikatz_openprocess_modules.html">
     Mimikatz OpenProcess Modules
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="process_access_rights.html">
     Process Security and Access Rights
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="security_account_manager_database.html">
     Security Account Manager (SAM) Database
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="security_account_manager_protocol.html">
     Security Account Manager Remote Protocol (SAMRP)
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="security_assertion_markup_language.html">
     Security Assertion Markup Language (SAML)
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="service_control_manager.html">
     Service Control Manager
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="syskey.html">
     SysKey
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="task_scheduler_service.html">
     Task Scheduler Service
    </a>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Pre-Hunt Activities
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../pre-hunt/data_management.html">
   Data Management
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../pre-hunt/data_documentation.html">
     Data Documentation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../pre-hunt/data_standardization.html">
     Data Standardization
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../pre-hunt/data_modeling.html">
     Data Modeling
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../pre-hunt/data_quality.html">
     Data Quality
    </a>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Guided Hunts
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../hunts/windows/intro.html">
   Windows
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../hunts/windows/170105-LSASSMemoryReadAccess/notebook.html">
     LSASS Memory Read Access
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../hunts/windows/180719-DLLProcessInjectionCreateRemoteThread/notebook.html">
     DLL Process Injection via CreateRemoteThread and LoadLibrary
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../hunts/windows/180815-ADObjectAccessReplication/notebook.html">
     Active Directory Object Access via Replication Services
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../hunts/windows/190101-ADModDirectoryReplication/notebook.html">
     Active Directory Root Domain Modification for Replication Services
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../hunts/windows/190407-RegModEnableRDPConnections/notebook.html">
     Registry Modification to Enable Remote Desktop Conections
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../hunts/windows/190410-LocalPwshExecution/notebook.html">
     Local PowerShell Execution
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../hunts/windows/190510-RegModWDigestDowngrade/notebook.html">
     WDigest Downgrade
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../hunts/windows/190511-RemotePwshExecution/notebook.html">
     PowerShell Remote Session
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../hunts/windows/190610-PwshAlternateHosts/notebook.html">
     Alternate PowerShell Hosts
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../hunts/windows/190620-DomainDPAPIBackupKeyExtraction/notebook.html">
     Domain DPAPI Backup Key Extraction
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../hunts/windows/190625-RegKeyAccessSyskey/notebook.html">
     SysKey Registry Keys Access
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../hunts/windows/190725-SAMRegistryHiveHandleRequest/notebook.html">
     SAM Registry Hive Handle Request
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../hunts/windows/190810-RemoteWMIExecution/notebook.html">
     WMI Win32_Process Class and Create Method for Remote Execution
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../hunts/windows/190810-WMIEventing/notebook.html">
     WMI Eventing
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../hunts/windows/190811-WMIModuleLoad/notebook.html">
     WMI Module Load
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../hunts/windows/190813-LocalServiceInstallation/notebook.html">
     Local Service Installation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../hunts/windows/190815-RemoteServiceInstallation/notebook.html">
     Remote Service creation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../hunts/windows/190826-RemoteSCMHandle/notebook.html">
     Remote Service Control Manager Handle
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../hunts/windows/191030-RemoteInteractiveTaskMgrLsassDump/notebook.html">
     Remote Interactive Task Manager LSASS Dump
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../hunts/windows/191224-RegModExtendedNetNTLMDowngrade/notebook.html">
     Registry Modification for Extended NetNTLM Downgrade
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../hunts/windows/200609-MicrophoneDvcAccess/notebook.html">
     Access to Microphone Device
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../hunts/windows/200902-RemoteWMIActiveScriptEventConsumers/notebook.html">
     Remote WMI ActiveScriptEventConsumers
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../hunts/windows/201009-RemoteDCOMIErtUtilDLLHijack/notebook.html">
     Remote DCOM IErtUtil DLL Hijack
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../hunts/windows/201009-RemoteWMIWbemcomnDLLHijack/notebook.html">
     Remote WMI Wbemcomn DLL Hijack
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../hunts/windows/201012-RemoteCreateFileSMB/notebook.html">
     SMB Create Remote File
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../hunts/windows/201012-WuaucltCreateRemoteThread/notebook.html">
     Wuauclt CreateRemoteThread Execution
    </a>
   </li>
  </ul>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Tutorials
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../tutorials/jupyter/introduction.html">
   Jupyter Notebooks
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
  <label for="toctree-checkbox-4">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../tutorials/jupyter/installing_jupyter.html">
     Jupyter Server Installation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../tutorials/jupyter/notebooks/01_intro_to_python.html">
     Introduction to Python
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../tutorials/jupyter/notebooks/02_intro_to_numpy_arrays.html">
     Introduction to Python NumPy Arrays
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../tutorials/jupyter/notebooks/03_intro_to_pandas.html">
     Introduction to Pandas
    </a>
   </li>
  </ul>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/OTRF/ThreatHunter-Playbook"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/OTRF/ThreatHunter-Playbook/issues/new?title=Issue%20on%20page%20%2Flibrary/windows/data_protection_api.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/OTRF/ThreatHunter-Playbook/edit/master/docs/library/windows/data_protection_api.md"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Edit this page"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="headerbtn__text-container">suggest edit</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../../_sources/library/windows/data_protection_api.md"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.md</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#password-based-data-protection-service">
   Password Based Data Protection Service
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#encrypt-decrypt">
   Encrypt / Decrypt
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#calling-dpapi-functions">
   Calling DPAPI Functions
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#master-key">
   Master Key
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#session-key">
   Session Key
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#recovery-key">
   Recovery Key
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#master-keys-expiration">
   Master Keys Expiration
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#master-keys-and-users-password-change">
   Master Keys and Users Password Change
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#key-backup-and-restoration-in-dpapi">
   Key Backup and Restoration in DPAPI
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#dpapi-secrets">
   DPAPI Secrets
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#user">
     User
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#system">
     System:
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#references">
   References
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Data Protection API</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#password-based-data-protection-service">
   Password Based Data Protection Service
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#encrypt-decrypt">
   Encrypt / Decrypt
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#calling-dpapi-functions">
   Calling DPAPI Functions
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#master-key">
   Master Key
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#session-key">
   Session Key
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#recovery-key">
   Recovery Key
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#master-keys-expiration">
   Master Keys Expiration
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#master-keys-and-users-password-change">
   Master Keys and Users Password Change
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#key-backup-and-restoration-in-dpapi">
   Key Backup and Restoration in DPAPI
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#dpapi-secrets">
   DPAPI Secrets
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#user">
     User
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#system">
     System:
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#references">
   References
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="data-protection-api">
<h1>Data Protection API<a class="headerlink" href="#data-protection-api" title="Permalink to this headline">#</a></h1>
<p>Starting with Microsoft® Windows® 2000, the operating system began to provide a data protection application-programming interface (API). This Data Protection API (DPAPI) is a pair of function calls  <code class="docutils literal notranslate"><span class="pre">(CryptProtectData</span> <span class="pre">/</span> <span class="pre">CryptUnprotectData)</span></code> that provide operating system-level data protection services to user and system processes. By operating system-level, we mean a service that is provided by the operating system itself and does not require any additional libraries. By data protection, we mean a service that provides confidentiality of data by using encryption. Because data protection is part of the operating system, every application can now secure data without needing any specific cryptographic code other than the necessary function calls to DPAPI.</p>
<div class="section" id="password-based-data-protection-service">
<h2>Password Based Data Protection Service<a class="headerlink" href="#password-based-data-protection-service" title="Permalink to this headline">#</a></h2>
<p>DPAPI is a password-based data protection service. It requires a password to provide protection. The drawback, of course, is that all protection provided by DPAPI rests on the password provided. Because DPAPI is focused on providing protection for users and requires a password to provide this protection, it logically uses the user’s logon password for protection. Because DPAPI requires a password to provide protection, the logical step is for DPAPI to use a user’s logon password, which it does, in a way. DPAPI actually uses the user’s logon credential. A small drawback to using the logon password is that all applications running under the same user can access any protected data that they know about.</p>
<p>DPAPI initially generates a strong key called a MasterKey, which is protected by the user’s password. DPAPI uses a standard cryptographic process called Password-Based Key Derivation to generate a key from the password. This password-derived key is then used with Triple-DES to encrypt the MasterKey, which is finally stored in the user’s profile directory.</p>
<p>The MasterKey, however, is not used explicitly to protect the data. Instead, a symmetric session key is generated based on the MasterKey, some random data, and any additional entropy, if an application chooses to supply it. It is this session key that is used to protect the data. The session key is never stored. Instead, DPAPI stores the random data it used to generate the key in the opaque data BLOB. When the data BLOB is passed back in to DPAPI, the random data is used to re-derive the key and unprotect the data.</p>
</div>
<div class="section" id="encrypt-decrypt">
<h2>Encrypt / Decrypt<a class="headerlink" href="#encrypt-decrypt" title="Permalink to this headline">#</a></h2>
<p>Applications either pass plaintext data to DPAPI and receive an opaque protected data BLOB back, or pass the protected data BLOB to DPAPI and receive the plaintext data back.</p>
<p>The protected data BLOB is an opaque structure because, in addition to the encrypted data, it also contains data to allow DPAPI to unprotect it. Being opaque, application developers do not need to parse or understand the format at all. An important point to remember is that DPAPI merely applies cryptographic protection to the data. It does not store any of the protected data; therefore applications calling DPAPI must implement their own storage of the protected data.</p>
</div>
<div class="section" id="calling-dpapi-functions">
<h2>Calling DPAPI Functions<a class="headerlink" href="#calling-dpapi-functions" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p>When an application calls one of the DPAPI functions, the functions make a local RPC call to the Local Security Authority (LSA).</p>
<ul>
<li><p>The LSA is a system process that starts on boot and runs until the computer is shut down. These local RPC calls never traverse the network, so all data remains on the local machine.</p></li>
</ul>
</li>
<li><p>The endpoints of these RPC calls then call DPAPI private functions to protect or unprotect the data.</p></li>
<li><p>These functions then call back into CryptoAPI, by using Crypt32.dll, for the actual encryption or decryption of the data in the security context of the LSA.</p></li>
<li><p>The functions run in the security context of the LSA so that security audits can be generated.</p></li>
</ul>
</div>
<div class="section" id="master-key">
<h2>Master Key<a class="headerlink" href="#master-key" title="Permalink to this headline">#</a></h2>
<p>DPAPI generates a strong key called the MasterKey. Calling the MasterKey a key isn’t really correct because it is never used in any explicit encryption or decryption functions. The MasterKey is more accurately a strong secret: strong because it is 512 bits of random data, and secret because it is used, with some additional data, to generate an actual symmetric session key.</p>
<p>To protect this secret, DPAPI uses the Password-Based Key Derivation Function, PBKDF2, described in PKCS #5.</p>
<ul class="simple">
<li><p>First, DPAPI takes the user’s password and passes it through SHA-1 to get a password hash.</p></li>
<li><p>Next, the password hash is provided to the PBKDF2 function, along with sixteen random bytes for a salt and an iteration count.</p></li>
<li><p>The PBKDF2 function calls an additional function a number of times, specified by the iteration count, to derive a key from the given data. DPAPI uses SHA-1 for that underlying function.</p></li>
</ul>
</div>
<div class="section" id="session-key">
<h2>Session Key<a class="headerlink" href="#session-key" title="Permalink to this headline">#</a></h2>
<p>The session key is the real symmetric key that is used for encrypting and decrypting the application data. DPAPI uses a simple process to derive the session key.</p>
</div>
<div class="section" id="recovery-key">
<h2>Recovery Key<a class="headerlink" href="#recovery-key" title="Permalink to this headline">#</a></h2>
<p>The recovery key is generated when a user chooses to create a Password Reset Disk (PRD) from the user’s Control Panel.</p>
<ul class="simple">
<li><p>First, DPAPI generates a 2048-bit RSA public/private key pair, which is the recovery key.</p></li>
<li><p>The current password is then encrypted with the public key and stored in the user’s profile, while the private key is stored to the PRD, which can actually be any removable media, and then removed from memory.</p></li>
<li><p>The private key is only stored on the PRD, and nowhere else, so it is important for a user to keep the PRD in a safe place.</p></li>
</ul>
</div>
<div class="section" id="master-keys-expiration">
<h2>Master Keys Expiration<a class="headerlink" href="#master-keys-expiration" title="Permalink to this headline">#</a></h2>
<p>For security reasons, MasterKeys will expire, which means that after a period of time (the hard-coded value being <code class="docutils literal notranslate"><span class="pre">three</span> <span class="pre">months</span></code>), a new MasterKey is generated and protected in the same manner. This expiration prevents an attacker from compromising a single MasterKey and accessing all of a user’s protected data.</p>
<p>You are probably wondering how an application can unprotect data that was protected under a MasterKey that has expired, because the session key is derived from the MasterKey, right? Well the answer involves a two-step process. First, DPAPI does not delete any expired MasterKeys. Instead, they are kept forever in the user’s profile directory, protected by the user’s password. Second, it stores the Globally Unique Identifier (GUID) of the MasterKey used to protect the data in the opaque data BLOB that is returned to applications. When the data BLOB is passed back in to DPAPI, the MasterKey that corresponds to the GUID is used to unprotect the data.</p>
</div>
<div class="section" id="master-keys-and-users-password-change">
<h2>Master Keys and Users Password Change<a class="headerlink" href="#master-keys-and-users-password-change" title="Permalink to this headline">#</a></h2>
<p>First, DPAPI hooks into the password-changing module and when a user’s password is changed, all MasterKeys are re-encrypted under the new password. Second, the system keeps a “Credential History” file in the user’s profile directory. When a user changes his or her password, the old password is added to the top of this file and then the file is encrypted by the new password. If necessary, DPAPI will use the current password to decrypt the “Credential History” file and try the old password to decrypt the MasterKey. If this fails, the old password is used to again decrypt the “Credential History” file and the next previous password is then tried. This continues until the MasterKey is successfully decrypted.</p>
</div>
<div class="section" id="key-backup-and-restoration-in-dpapi">
<h2>Key Backup and Restoration in DPAPI<a class="headerlink" href="#key-backup-and-restoration-in-dpapi" title="Permalink to this headline">#</a></h2>
<p>When a computer is a member of a domain, DPAPI has a backup mechanism to allow unprotection of the data. When a Master Key is generated, DPAPI communicates with a domain controller. Domain controllers have a domain-wide public/private key pair, associated solely with DPAPI. The local DPAPI client gets the domain controller public key from a domain controller by using a mutually authenticated and privacy protected RPC call. The client encrypts the Master Key with the domain controller public key. It then stores this backup Master Key along with the Master Key protected by the user’s password.</p>
<p>Periodically, a domain-joined machine will try to send an RPC request to a domain controller to back up the user’s master key so that the user can recover secrets in case his or her password has to be reset. Although the user’s keys are stored in the user profile, a domain controller must be contacted to encrypt the master key with a domain recovery key.</p>
<p>When DPAPI is used in an Active Directory domain environment, two copies of the master key are created and updated whenever an operation is performed on the master key. The first copy is protected by the user password as described earlier in this article. The second copy is encrypted with a public key that is associated with the domain controllers in the domain. The private key that is associated with this public key is known to all of the Windows 2000 and later domain controllers. Windows 2000 domain controllers use a symmetric key to encrypt and decrypt the second copy of the master key.</p>
<p>While unprotecting data, if DPAPI cannot use the MasterKey protected by the user’s password, it sends the backup MasterKey to a Domain Controller by using a mutually authenticated and privacy protected RPC call. The Domain Controller then decrypts the MasterKey with its private key and sends it back to the client by using the same protected RPC call. This protected RPC call is used to ensure that no one listening on the network can get the MasterKey.</p>
</div>
<div class="section" id="dpapi-secrets">
<h2>DPAPI Secrets<a class="headerlink" href="#dpapi-secrets" title="Permalink to this headline">#</a></h2>
<div class="section" id="user">
<h3>User<a class="headerlink" href="#user" title="Permalink to this headline">#</a></h3>
<ul class="simple">
<li><p>Windows “Credentials” (like saved RDP creds)</p></li>
<li><p>Windows Vaults</p></li>
<li><p>Saved IE and Chrome logins/cookies</p></li>
<li><p>Remote Desktop Connection Manager files with passwords</p></li>
<li><p>Dropbox syncs</p></li>
</ul>
</div>
<div class="section" id="system">
<h3>System:<a class="headerlink" href="#system" title="Permalink to this headline">#</a></h3>
<ul class="simple">
<li><p>Scheduled tasks</p></li>
<li><p>Azure sync accounts</p></li>
<li><p>Wifi passwords</p></li>
</ul>
</div>
</div>
<div class="section" id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://docs.microsoft.com/en-us/dotnet/standard/security/how-to-use-data-protection">https://docs.microsoft.com/en-us/dotnet/standard/security/how-to-use-data-protection</a></p></li>
<li><p><a class="reference external" href="https://support.microsoft.com/en-us/help/309408/how-to-troubleshoot-the-data-protection-api-dpapi">https://support.microsoft.com/en-us/help/309408/how-to-troubleshoot-the-data-protection-api-dpapi</a></p></li>
<li><p><a class="reference external" href="https://docs.microsoft.com/en-us/previous-versions/ms995355(v=msdn.10)">https://docs.microsoft.com/en-us/previous-versions/ms995355(v=msdn.10)</a></p></li>
</ul>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "OTRF/ThreatHunter-Playbook",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./library\windows"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="adfs_dkm_keys.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Active Directory Federation Services (ADFS) Distributed Key Manager (DKM) Keys</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="logon_session.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Logon Session</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Roberto Rodriguez @Cyb3rWard0g<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>